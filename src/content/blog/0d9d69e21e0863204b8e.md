---
title: "S3をWebサーバーにしてコンテンツを公開する②（S3署名付きURL編）"
pubDate: "2021-03-08"
tags: ["AWS", "S3"]
---

S3をWebサーバーにして静的コンテンツを公開する方法を紹介します。

1. [S3パブリック編](https://qiita.com/morikaz/items/8d196844aed38d0d8d0b)
2. [S3署名付きURL編](https://qiita.com/morikaz/items/0d9d69e21e0863204b8e)　←コレ！
3. [CloudFrontパブリック編](https://qiita.com/morikaz/items/04c053ead497e2a7c86c)
4. [CloudFront署名付きURL編](https://qiita.com/morikaz/items/f3159562caa133916bce)
5. [CloudFront署名付きCookie編](https://qiita.com/morikaz/items/741fc1073dff746f7089)

# 手順

## バケットの作成

まずはバケットを作成しましょう。

マネジメントコンソールでS3のページを開きます。
バケットを作成をクリックします。

![s3.console.aws.amazon.com_s3_home_region=ap-northeast-1(iPad).png](/images/qiita/a0698048-1503-f126-7ed0-b5c3f5135d75.png)

バケットの名前を入れて、リージョンを選択します。
バケット名は世界中のS3で一意である必要があります。

![s3.console.aws.amazon.com_s3_home_region=ap-northeast-1(iPad) (1).png](/images/qiita/0b2e95c3-c631-4d27-6367-c1314ee01352.png)

署名付きURLで公開する場合は、「バケットのブロックパブリックアクセス設定」はデフォルトのすべてブロックで問題ありません。

![s3.console.aws.amazon.com_s3_home_region=ap-northeast-3(iPad).png](/images/qiita/0bc1268b-62a5-2343-d956-87ee614406b3.png)

これでバケット作成は完了です。

## HTMLの格納

作成したバケットを選択します。
そして、HTMLファイルをドラッグアンドドロップします。

![s3.console.aws.amazon.com_s3_home_region=ap-northeast-1(iPad) (3).png](/images/qiita/c8507633-f0b0-c65c-26e1-361416f4d065.png)

設定が色々ありますが、画面最下部のアップロードを実行します。

![s3.console.aws.amazon.com_s3_home_region=ap-northeast-1(iPad) (4).png](/images/qiita/393f9aa4-4e81-415d-bb6c-41c37ec87f2c.png)

複数ファイルやフォルダーまるごとアップロードすることも可能です。

## 公開する

署名付きURLのURLはマネジメントコンソールでは作成できず、CLIなどを利用して作成します。
CloudShellを使うと簡単にCLIを実行できます。

![ap-northeast-1.console.aws.amazon.com_cloudshell_home_region=ap-northeast-1(iPad).png](/images/qiita/a9e48ad4-9092-a8cd-9e5b-65c341e5185b.png)

実行するコマンドは`aws s3 presign`です。

```console
[cloudshell-user@ip-XX-XX-XX-XX ~]$ aws s3 presign s3://website-2721ae93/index.html --expires-in 604800 --region ap-northeast-3
```

`expires`は署名付きURLの有効期限です。（604800を指定すると、一週間有効となります。）
少しだけハマったのですが、CloudShellが東京リージョンで実行されてて、S3のバケットが大阪リージョンの場合、明示的に`--region ap-northeast-3`をつけないと、無効な署名付きURLが生成されます。（生成は成功しますが、アクセスすると`AuthorizationQueryParametersError`というエラーとなります）

発行された署名付きURLは、クエリパラメータに以下の文字が付与されており、コレが適切に設定されている場合のみ、ファイルにアクセスができるという仕組みです。

```
X-Amz-Algorithm=XXXXXXXXXX
X-Amz-Credential=XXXXXXXXXX
X-Amz-Date=XXXXXXXXXX
X-Amz-Expires=XXXXXXXXXX
X-Amz-SignedHeaders=XXXXXXXXXX
X-Amz-Security-Token=XXXXXXXXXX
X-Amz-Signature=XXXXXXXXXX
```
